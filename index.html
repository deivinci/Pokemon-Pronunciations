<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¯¶å¯å¤¢ä¸­è‹±æ—¥ç™¼éŸ³ï½œPokÃ©mon GO ä¸‰èªæœå°‹ï¼ˆå«é™å®šæ‹›å¼ï¼‰</title>
    <style>
      :root {
        --bg: #0b1220;
        --card: #111827;
        --muted: #9ca3af;
        --text: #e5e7eb;
        --accent: #60a5fa;
        --chip: #1f2937;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: linear-gradient(180deg, #0b1220 0%, #0f172a 100%);
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto,
          "Noto Sans TC", "Hiragino Sans", "Microsoft JhengHei", sans-serif;
        color: var(--text);
      }
      header {
        position: sticky;
        top: 0;
        z-index: 50;
        background: rgba(10, 15, 28, 0.85);
        backdrop-filter: saturate(150%) blur(8px);
        border-bottom: 1px solid #1f2937;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px;
      }
      .title {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 6px;
        margin: 8px 0 12px;
      }
      .title h1 {
        margin: 0;
        font-size: 22px;
        font-weight: 800;
        letter-spacing: 0.5px;
      }
      .title h1:nth-child(1) {
        color: #fff;
      }
      .title h1:nth-child(2) {
        color: #c7d2fe;
      }
      .title h1:nth-child(3) {
        color: #93c5fd;
      }
      .controls {
        display: grid;
        grid-template-columns: 1fr 180px 160px 140px;
        gap: 10px;
      }
      .search {
        position: relative;
      }
      input,
      select,
      button {
        width: 100%;
        border: 1px solid #374151;
        background: #0b1020;
        color: #e5e7eb;
        padding: 10px 12px;
        border-radius: 12px;
        outline: none;
      }
      input::placeholder {
        color: #6b7280;
      }
      .hint {
        font-size: 12px;
        color: var(--muted);
        margin-top: 4px;
      }
      .toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: flex-end;
      }
      .toggle input {
        width: auto;
      }
      main {
        padding: 16px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 14px;
      }
      .card {
        background: var(--card);
        border: 1px solid #1f2937;
        border-radius: 18px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .card .head {
        display: flex;
        gap: 12px;
        padding: 12px;
        border-bottom: 1px solid #1f2937;
      }
      .sprite {
        width: 84px;
        height: 84px;
        background: #0b1020;
        border-radius: 14px;
        display: grid;
        place-items: center;
        overflow: hidden;
        border: 1px solid #1f2937;
      }
      .sprite img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        image-rendering: crisp-edges;
      }
      .names {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .name-line {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .name-tag {
        font-size: 12px;
        padding: 2px 6px;
        border-radius: 999px;
        background: var(--chip);
        border: 1px solid #2a3343;
        color: #93c5fd;
      }
      .name-text {
        font-size: 14px;
        font-weight: 700;
      }
      .tts {
        display: flex;
        gap: 8px;
        margin-top: 6px;
      }
      .tts button {
        flex: 1;
        cursor: pointer;
      }
      .pill {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        padding: 4px 8px;
        background: #0b1020;
        border: 1px solid #1f2937;
        border-radius: 999px;
        font-size: 12px;
        color: #cbd5e1;
      }
      .pill .ex {
        margin-left: 4px;
        font-weight: 800;
        color: #fb923c;
      }
      details {
        border-top: 1px solid #1f2937;
      }
      summary {
        cursor: pointer;
        list-style: none;
        padding: 10px 12px;
        font-weight: 700;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 8px 10px;
        border-top: 1px dashed #293241;
        font-size: 13px;
        vertical-align: middle;
      }
      th {
        color: #9ca3af;
        text-align: left;
      }
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 6px;
      }
      .stat {
        font-family: ui-monospace, monospace;
        font-size: 12px;
        opacity: 0.9;
      }
      .footer {
        color: #94a3b8;
        font-size: 12px;
        margin-top: 8px;
      }
      .region {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .badge {
        background: #0b1020;
        border: 1px solid #1f2937;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
      }
      .empty {
        opacity: 0.7;
        text-align: center;
        padding: 40px;
      }
      .loader {
        display: none;
        gap: 8px;
        align-items: center;
      }
      .loader.active {
        display: flex;
      }
      .spinner {
        width: 14px;
        height: 14px;
        border: 3px solid #334155;
        border-top-color: #93c5fd;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .diag {
        max-width: 1200px;
        margin: 20px auto;
        color: #9ca3af;
        font-size: 12px;
      }
      .diag pre {
        background: #0b1020;
        border: 1px solid #1f2937;
        border-radius: 10px;
        padding: 10px;
        overflow: auto;
      }
      .move-tts-btn {
        margin-left: 6px;
        padding: 2px 6px;
        border-radius: 8px;
        border: 1px solid #334155;
        background: #0b1020;
        color: #cbd5e1;
        cursor: pointer;
      }
      .move-tts-btn.playing {
        border-color: #93c5fd;
        transform: scale(1.05);
      }
      .name-tts-btn {
        margin-left: 6px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid #334155;
        background: #0b1020;
        color: #cbd5e1;
        cursor: pointer;
      }
      .name-tts-btn.playing {
        border-color: #93c5fd;
        transform: scale(1.05);
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="title">
          <h1>å¯¶å¯å¤¢ä¸­è‹±æ—¥ç™¼éŸ³</h1>
          <h1>PokÃ©mon English, Chinese, and Japanese Pronunciations</h1>
          <h1>ãƒã‚±ãƒ¢ãƒ³ã®è‹±èªã€ä¸­å›½èªã€æ—¥æœ¬èªã®ç™ºéŸ³</h1>
        </div>
        <div class="controls">
          <div class="search">
            <input
              id="q"
              placeholder="æœå°‹å¯¶å¯å¤¢æˆ–æ‹›å¼ï¼ˆæ”¯æ´ ä¸­/è‹±/æ—¥ï¼‰e.g. å¦™è›™ã€Bulbaã€ãƒ•ã‚·ã‚®â€¦"
            />
            <div class="hint">è·¨åœ°å€å…¨åŸŸæœå°‹ã€‚åç¨±/åˆ¥å/æ‹›å¼çš†å¯ã€‚</div>
          </div>
          <select id="region">
            <option value="all">å…¨éƒ¨åœ°å€</option>
            <option value="kanto">é—œéƒ½ (1â€“151)</option>
            <option value="johto">åŸéƒ½ (152â€“251)</option>
            <option value="hoenn">è±ç·£ (252â€“386)</option>
            <option value="sinnoh">ç¥å¥§ (387â€“493)</option>
            <option value="unova">åˆçœ¾ (494â€“649)</option>
            <option value="kalos">å¡æ´›æ–¯ (650â€“721)</option>
            <option value="alola">é˜¿ç¾…æ‹‰ (722â€“809)</option>
            <option value="galar">ä¼½å‹’çˆ¾ (810â€“898)</option>
            <option value="paldea">å¸•åº•äº (906â€“1017)</option>
          </select>
          <select id="sort">
            <option value="dex">ä¾åœ–é‘‘ç·¨è™Ÿ</option>
            <option value="name_en">åç¨± (EN)</option>
            <option value="name_zh">åç¨± (ä¸­æ–‡)</option>
            <option value="name_ja">åç¨± (æ—¥æ–‡)</option>
          </select>
          <label class="toggle">
            <input id="expand" type="checkbox" /> å±•é–‹æ‹›å¼å°ç…§è¡¨
          </label>
        </div>
        <div class="loader" id="loader">
          <div class="spinner"></div>
          <div>è³‡æ–™è¼‰å…¥ä¸­â€¦ï¼ˆPoGoAPI + PokÃ©APIï¼‰</div>
        </div>
      </div>
    </header>

    <main class="container">
      <div id="results" class="grid"></div>
      <div id="empty" class="empty">è¼¸å…¥é—œéµå­—æˆ–é¸æ“‡åœ°å€é–‹å§‹ç€è¦½ã€‚</div>
      <div class="footer">
        è³‡æ–™ä¾†æºï¼šPoGoAPIï¼ˆMoves & é…æ‹›ï¼‰èˆ‡ PokÃ©APIï¼ˆå¤šèªåç¨±èˆ‡åœ–ç‰‡ï¼‰ã€‚EPS/DPS
        ä»¥ PoGo ä¸€èˆ¬æˆ°é¬¥æ•¸æ“šè¨ˆç®—ã€‚è‹¥å¤–éƒ¨ API
        ç„¡æ³•é€£ç·šï¼Œé é¢å°‡è‡ªå‹•åˆ‡æ›åˆ°å…§å»ºå°å‹é›¢ç·šè³‡æ–™ä»¥ä¾¿æ¸¬è©¦ã€‚é™å®šæ‹›å¼ä»¥å…§å»º JSON
        å­—å…¸è£œé½Šï¼ˆå¼·åˆ¶é¡¯ç¤ºï¼‰ã€‚
      </div>
    </main>

    <section class="diag container">
      <details>
        <summary>è¨ºæ–· / æ¸¬è©¦ï¼ˆå±•é–‹çœ‹è‡ªå‹•æ¸¬è©¦çµæœï¼‰</summary>
        <pre id="diag"></pre>
      </details>
    </section>

    <script>
      (async function () {
        // -------- Polyfills --------
        if (!Promise.any) {
          Promise.any = (iterable) =>
            new Promise((resolve, reject) => {
              let rejections = 0;
              const errors = [];
              const arr = Array.from(iterable);
              if (arr.length === 0)
                return reject(
                  new AggregateError([], "All promises were rejected")
                );
              arr.forEach((p, i) =>
                Promise.resolve(p).then(resolve, (e) => {
                  errors[i] = e;
                  if (++rejections === arr.length)
                    reject(
                      new AggregateError(errors, "All promises were rejected")
                    );
                })
              );
            });
        }

        const $ = (s, r = document) => r.querySelector(s);
        const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
        const loader = $("#loader");
        const results = $("#results");
        const empty = $("#empty");
        const diag = $("#diag");
        const qInput = $("#q");
        const regionSel = $("#region");
        const sortSel = $("#sort");
        const expandChk = $("#expand");

        // --- Region ranges (National Dex) ---
        const REGIONS = {
          kanto: [1, 151],
          johto: [152, 251],
          hoenn: [252, 386],
          sinnoh: [387, 493],
          unova: [494, 649],
          kalos: [650, 721],
          alola: [722, 809],
          galar: [810, 898],
          paldea: [906, 1017],
        };

        // --- External APIs ---
        const POGO = {
          fastMoves: "https://pogoapi.net/api/v1/fast_moves.json",
          chargedMoves: "https://pogoapi.net/api/v1/charged_moves.json",
          pokemonMoves: "https://pogoapi.net/api/v1/current_pokemon_moves.json",
        };
        const POKE = {
          move: (name) => `https://pokeapi.co/api/v2/move/${name}`,
          species: (id) => `https://pokeapi.co/api/v2/pokemon-species/${id}`,
          art: (id) =>
            `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`,
        };

        // ---- Embedded fallback species names ----
        const SPECIES_FALLBACK = {
          1: { en: "Bulbasaur", zh: "å¦™è›™ç¨®å­", ja: "ãƒ•ã‚·ã‚®ãƒ€ãƒ" },
          3: { en: "Venusaur", zh: "å¦™è›™èŠ±", ja: "ãƒ•ã‚·ã‚®ãƒãƒŠ" },
          6: { en: "Charizard", zh: "å™´ç«é¾", ja: "ãƒªã‚¶ãƒ¼ãƒ‰ãƒ³" },
          9: { en: "Blastoise", zh: "æ°´ç®­é¾œ", ja: "ã‚«ãƒ¡ãƒƒã‚¯ã‚¹" },
          25: { en: "Pikachu", zh: "çš®å¡ä¸˜", ja: "ãƒ”ã‚«ãƒãƒ¥ã‚¦" },
        };

        // ---- Embedded fallback for PoGo data (if fetch fails) ----
        const FALLBACK = {
          fast: [
            {
              name: "Tackle",
              duration: 500,
              energy_delta: 5,
              power: 5,
              kind: "fast",
            },
            {
              name: "Vine Whip",
              duration: 600,
              energy_delta: 8,
              power: 7,
              kind: "fast",
            },
          ],
          charged: [
            {
              name: "Solar Beam",
              duration: 4900,
              energy_delta: -100,
              power: 180,
              kind: "charged",
            },
            {
              name: "Sludge Bomb",
              duration: 2300,
              energy_delta: -50,
              power: 80,
              kind: "charged",
            },
          ],
          pokeMoves: [
            {
              pokemon_id: 3,
              fast_moves: ["Vine Whip"],
              charged_moves: ["Solar Beam", "Sludge Bomb"],
            },
            {
              pokemon_id: 6,
              fast_moves: ["Tackle"],
              charged_moves: ["Solar Beam"],
            },
            {
              pokemon_id: 9,
              fast_moves: ["Tackle"],
              charged_moves: ["Solar Beam"],
            },
          ],
        };

        // ---- GO é™å®šæ‹›å¼å­—å…¸ï¼ˆå…§å»º JSONï¼›ä¸‰èª + kindï¼‰----
        // è‹¥æŸäº›åè©æ²’æœ‰å®˜æ–¹ä¸­/æ—¥ç¿»ï¼Œæœƒé€€å›è‹±æ–‡ï¼ˆä½ å¯è‡ªè¡Œæ“´å……/ä¿®æ­£ï¼‰
        const EXCLUSIVE_DICT = {
          "Frenzy Plant": {
            zh: "ç˜‹ç‹‚æ¤ç‰©",
            ja: "ãƒãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³ãƒˆ",
            kind: "charged",
          },
          "Blast Burn": {
            zh: "çˆ†ç‚¸çƒˆç„°",
            ja: "ãƒ–ãƒ©ã‚¹ãƒˆãƒãƒ¼ãƒ³",
            kind: "charged",
          },
          "Hydro Cannon": {
            zh: "åŠ è¾²æ°´ç ²",
            ja: "ãƒã‚¤ãƒ‰ãƒ­ã‚«ãƒãƒ³",
            kind: "charged",
          },
          "Sacred Sword": { zh: "è–åŠ", ja: "ã›ã„ãªã‚‹ã¤ã‚‹ã", kind: "charged" },
          Aeroblast: { zh: "æ°£æ—‹æ”»æ“Š", ja: "ã‚¨ã‚¢ãƒ­ãƒ–ãƒ©ã‚¹ãƒˆ", kind: "charged" },
          "Sacred Fire": {
            zh: "ç¥è–ä¹‹ç«",
            ja: "ã›ã„ãªã‚‹ã»ã®ãŠ",
            kind: "charged",
          },
          "Dragon Ascent": {
            zh: "ç•«é¾é»ç›",
            ja: "ã‚¬ãƒªãƒ§ã‚¦ãƒ†ãƒ³ã‚»ã‚¤",
            kind: "charged",
          },
          "Roar of Time": {
            zh: "æ™‚å…‰å’†å“®",
            ja: "ã¨ãã®ã»ã†ã“ã†",
            kind: "charged",
          },
          "Spacial Rend": {
            zh: "äºç©ºè£‚æ–¬",
            ja: "ã‚ãã†ã›ã¤ã ã‚“",
            kind: "charged",
          },
          "Fusion Flare": {
            zh: "äº¤éŒ¯ç«ç„°",
            ja: "ã‚¯ãƒ­ã‚¹ãƒ•ãƒ¬ã‚¤ãƒ ",
            kind: "charged",
          },
          "Fusion Bolt": {
            zh: "äº¤éŒ¯é–ƒé›»",
            ja: "ã‚¯ãƒ­ã‚¹ã‚µãƒ³ãƒ€ãƒ¼",
            kind: "charged",
          },
          "Precipice Blades": {
            zh: "æ–·å´–ä¹‹åŠ",
            ja: "ã ã‚“ãŒã„ã®ã¤ã‚‹ã",
            kind: "charged",
          },
          "Origin Pulse": {
            zh: "æ ¹æºæ³¢å‹•",
            ja: "ã“ã‚“ã’ã‚“ã®ã¯ã©ã†",
            kind: "charged",
          },
          "Nature's Madness": {
            zh: "è‡ªç„¶ä¹‹æ€’",
            ja: "ã—ãœã‚“ã®ã„ã‹ã‚Š",
            kind: "charged",
          },
          "Meteor Beam": {
            zh: "æµæ˜Ÿå…‰æŸ",
            ja: "ãƒ¡ãƒ†ã‚ªãƒ“ãƒ¼ãƒ ",
            kind: "charged",
          },
          "Behemoth Blade": {
            zh: "å·¨ç¸æ–¬",
            ja: "ãã‚‡ã˜ã‚…ã†ã–ã‚“",
            kind: "charged",
          },
          "Behemoth Bash": {
            zh: "å·¨ç¸å½ˆ",
            ja: "ãã‚‡ã˜ã‚…ã†ã ã‚“",
            kind: "charged",
          },
        };

        // ---- é™å®šæ‹›å¼å°æ‡‰å¯¶å¯å¤¢ï¼ˆNational Dex ID â†’ é™å®šè‹±æ–‡æ‹›å¼é™£åˆ—ï¼‰----
        // ä½ å¯æŒçºŒæ“´å……ï¼š starters / å‚³èªª / æº–ç¥ ç­‰
        const EXCLUSIVE_BY_POKEMON = {
          3: ["Frenzy Plant"], //Venusaur
          6: ["Blast Burn"], // Charizard
          9: ["Hydro Cannon"], // Blastoise
          154: ["Frenzy Plant"], // Meganium
          157: ["Blast Burn"], // Typhlosion
          160: ["Hydro Cannon"], // Feraligatr
          254: ["Frenzy Plant"],
          257: ["Blast Burn"],
          260: ["Hydro Cannon"],
          389: ["Frenzy Plant"], // Torterra
          392: ["Blast Burn"], // Infernape
          395: ["Hydro Cannon"], // Empoleon
          497: ["Frenzy Plant"], // Serperior
          500: ["Blast Burn"], // Emboar
          503: ["Hydro Cannon"], // Samurott
          652: ["Frenzy Plant"],
          655: ["Blast Burn"],
          658: ["Hydro Cannon"],
          724: ["Frenzy Plant"],
          727: ["Blast Burn"],
          730: ["Hydro Cannon"],
          812: ["Frenzy Plant"],
          815: ["Blast Burn"],
          818: ["Hydro Cannon"],
          908: ["Frenzy Plant"],
          911: ["Blast Burn"],
          914: ["Hydro Cannon"],
          649: ["Techno Blast"], //ï¼ˆç¤ºä¾‹ï¼Œå¦‚éœ€å¯åŠ åœ¨å­—å…¸ï¼‰
          638: ["Sacred Sword"],
          639: ["Sacred Sword"],
          640: ["Sacred Sword"], // Cobalion
          382: ["Origin Pulse"],
          383: ["Precipice Blades"],
          643: ["Fusion Flare"],
          644: ["Fusion Bolt"],
          249: ["Aeroblast"],
          250: ["Sacred Fire"],
          888: ["Behemoth Blade"],
          889: ["Behemoth Bash"],
          484: ["Spacial Rend"],
          483: ["Roar of Time"],
          526: ["Meteor Beam"], //é¾å²©æ€ª
        };

        const LANGS = { zh: "zh-TW", en: "en-US", ja: "ja-JP" };
        let ttsNowBtn = null;
        const speak = (text, langCode, btn) => {
          if (!("speechSynthesis" in window))
            return alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆ");
          try {
            speechSynthesis.cancel();
          } catch {}
          if (ttsNowBtn) ttsNowBtn.classList.remove("playing");
          const u = new SpeechSynthesisUtterance(text);
          u.lang = langCode;
          const voices = speechSynthesis.getVoices();
          const v = voices.find((v) =>
            v.lang?.toLowerCase().startsWith(langCode.toLowerCase())
          );
          if (v) u.voice = v;
          u.onstart = () => {
            if (btn) {
              btn.classList.add("playing");
              ttsNowBtn = btn;
            }
          };
          u.onend = () => {
            if (btn) {
              btn.classList.remove("playing");
              if (ttsNowBtn === btn) ttsNowBtn = null;
            }
          };
          speechSynthesis.speak(u);
        };

        const toSlug = (name) =>
          name
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, "-")
            .replace(/(^-|-$)/g, "");

        const state = {
          fast: [],
          charged: [],
          moveIndex: {},
          pokeMoves: [],
          speciesNames: {},
          cacheMoveNames: {},
        };

        // Robust fetch with timeout & retries
        async function getJSON(
          url,
          { timeout = 12000, retries = 2, backoff = 1.8 } = {}
        ) {
          let attempt = 0;
          let lastErr;
          while (attempt <= retries) {
            const ctrl = new AbortController();
            const t = setTimeout(() => ctrl.abort(), timeout);
            try {
              const res = await fetch(url, {
                mode: "cors",
                signal: ctrl.signal,
                cache: "no-cache",
              });
              clearTimeout(t);
              if (!res.ok) throw new Error(`HTTP ${res.status}`);
              return await res.json();
            } catch (e) {
              clearTimeout(t);
              lastErr = e;
              await new Promise((r) =>
                setTimeout(r, Math.pow(backoff, attempt) * 400)
              );
              attempt++;
            }
          }
          console.warn("getJSON failed:", url, lastErr);
          return null;
        }

        async function loadAll() {
          loader.classList.add("active");
          try {
            let [fast, charged, pokeMoves] = await Promise.all([
              getJSON(POGO.fastMoves),
              getJSON(POGO.chargedMoves),
              getJSON(POGO.pokemonMoves),
            ]);

            if (
              !Array.isArray(fast) ||
              !Array.isArray(charged) ||
              !Array.isArray(pokeMoves)
            ) {
              console.warn("å¤–éƒ¨ API ç„¡æ³•å–å¾—ï¼Œä½¿ç”¨å…§å»ºé›¢ç·šè³‡æ–™");
              fast = FALLBACK.fast;
              charged = FALLBACK.charged;
              pokeMoves = FALLBACK.pokeMoves;
            }

            // å»é‡ï¼ˆé¿å…åŒä¸€ dex é‡è¤‡ï¼‰
            const seen = new Set();
            pokeMoves = pokeMoves.filter((p) => {
              if (seen.has(p.pokemon_id)) return false;
              seen.add(p.pokemon_id);
              return true;
            });

            state.fast = fast;
            state.charged = charged;
            state.pokeMoves = pokeMoves;

            state.moveIndex = Object.fromEntries([
              ...fast.map((m) => [m.name, { ...m, kind: "fast" }]),
              ...charged.map((m) => [m.name, { ...m, kind: "charged" }]),
            ]);

            // å°‡é™å®šæ‹›å¼ï¼ˆè‹¥ API æœªæä¾›ï¼‰å»ºå…¥ moveIndexï¼ˆç„¡æ³•å–å¾—æ•¸å€¼å‰‡åƒ…é¡¯ç¤º EXï¼Œä¸åƒèˆ‡æ’åºï¼‰
            for (const [name, meta] of Object.entries(EXCLUSIVE_DICT)) {
              if (!state.moveIndex[name]) {
                state.moveIndex[name] = {
                  name,
                  power: null,
                  duration: null,
                  energy_delta: null,
                  kind: meta.kind || "charged",
                  ex: true,
                };
              } else {
                // æ¨™è¨˜ç‚º EXï¼ˆå³ä½¿ API æœ‰ä¹Ÿé¡¯ç¤º EX æ¨™èªŒï¼‰
                state.moveIndex[name].ex = true;
              }
            }
          } catch (e) {
            console.error(e);
            alert("è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œå·²åˆ‡æ›åˆ°é›¢ç·šç¤ºä¾‹è³‡æ–™ã€‚");
            state.fast = FALLBACK.fast;
            state.charged = FALLBACK.charged;
            state.pokeMoves = FALLBACK.pokeMoves;
            state.moveIndex = Object.fromEntries([
              ...state.fast.map((m) => [m.name, m]),
              ...state.charged.map((m) => [m.name, m]),
            ]);
            for (const [name, meta] of Object.entries(EXCLUSIVE_DICT)) {
              if (!state.moveIndex[name]) {
                state.moveIndex[name] = {
                  name,
                  power: null,
                  duration: null,
                  energy_delta: null,
                  kind: meta.kind || "charged",
                  ex: true,
                };
              } else {
                state.moveIndex[name].ex = true;
              }
            }
          } finally {
            loader.classList.remove("active");
            await render();
            runSelfTests();
          }
        }

        // fetch tri-lingual names for a species id, cached
        async function getSpeciesNames(id) {
          if (state.speciesNames[id]) return state.speciesNames[id];
          const res = await getJSON(POKE.species(id));
          if (!res) {
            const names = SPECIES_FALLBACK[id] || {
              en: `#${id}`,
              ja: `#${id}`,
              zh: `#${id}`,
            };
            state.speciesNames[id] = names;
            return names;
          }
          const names = { en: "", ja: "", zh: "" };
          for (const n of res.names || []) {
            if (n.language.name === "en") names.en = n.name;
            if (n.language.name === "ja-Hrkt" || n.language.name === "ja")
              names.ja = n.name;
            if (n.language.name === "zh-Hant") names.zh = n.name;
          }
          if (!names.en) names.en = SPECIES_FALLBACK[id]?.en || `#${id}`;
          if (!names.ja) names.ja = SPECIES_FALLBACK[id]?.ja || names.en;
          if (!names.zh) names.zh = SPECIES_FALLBACK[id]?.zh || names.en;
          state.speciesNames[id] = names;
          return names;
        }

        // fetch tri-lingual names for a move by EN name
        async function getMoveNames(enName) {
          if (state.cacheMoveNames[enName]) return state.cacheMoveNames[enName];

          // å…ˆçœ‹å…§å»º EX å­—å…¸ï¼ˆå„ªå…ˆæä¾›ä¸‰èªï¼‰
          if (EXCLUSIVE_DICT[enName]) {
            const { zh, ja } = EXCLUSIVE_DICT[enName];
            const names = { en: enName, zh: zh || enName, ja: ja || enName };
            state.cacheMoveNames[enName] = names;
            return names;
          }

          const slug = toSlug(enName);
          const res = await getJSON(POKE.move(slug));
          if (!res) {
            const names = { en: enName, ja: enName, zh: enName };
            state.cacheMoveNames[enName] = names;
            return names;
          }
          const names = { en: enName, ja: "", zh: "" };
          for (const n of res.names || []) {
            if (n.language.name === "en") names.en = n.name;
            if (n.language.name === "ja-Hrkt" || n.language.name === "ja")
              names.ja = n.name;
            if (n.language.name === "zh-Hant") names.zh = n.name;
          }
          if (!names.ja) names.ja = names.en;
          if (!names.zh) names.zh = names.en;
          state.cacheMoveNames[enName] = names;
          return names;
        }

        function inRegion(id, region) {
          if (region === "all") return true;
          const [a, b] = REGIONS[region];
          return id >= a && id <= b;
        }

        function computeEPS(m) {
          if (!m || m.duration == null || m.energy_delta == null) return null;
          return (m.energy_delta || 0) / ((m.duration || 1000) / 1000);
        }
        function computeDPS(m) {
          if (!m || m.duration == null || m.power == null) return null;
          return (m.power || 0) / ((m.duration || 1000) / 1000);
        }

        function sortPokemon(list) {
          const key = sortSel.value;
          if (key === "dex")
            return list.sort((a, b) => a.pokemon_id - b.pokemon_id);
          if (key === "name_en")
            return list.sort((a, b) =>
              (a.names?.en || "").localeCompare(b.names?.en || "")
            );
          if (key === "name_zh")
            return list.sort((a, b) =>
              (a.names?.zh || "").localeCompare(b.names?.zh || "")
            );
          if (key === "name_ja")
            return list.sort((a, b) =>
              (a.names?.ja || "").localeCompare(b.names?.ja || "")
            );
          return list;
        }

        let filtered = [];

        async function render() {
          const q = qInput.value.trim();
          const region = regionSel.value;
          results.innerHTML = "";

          // Primary filter by region & unique by pokemon_id
          let list = state.pokeMoves.filter((p) =>
            inRegion(p.pokemon_id, region)
          );
          const uniq = new Map();
          for (const p of list) {
            if (!uniq.has(p.pokemon_id)) uniq.set(p.pokemon_id, p);
          }
          list = Array.from(uniq.values());

          await Promise.all(
            list.map(async (p) => {
              p.names = await getSpeciesNames(p.pokemon_id);
            })
          );

          if (q) {
            const qlc = q.toLowerCase();
            const out = [];
            for (const p of list) {
              const nameHit = [p.names.zh, p.names.en, p.names.ja].some(
                (n) => n && String(n).toLowerCase().includes(qlc)
              );
              let moveHit = false;
              if (!nameHit) {
                const directHit = (arr) =>
                  (arr || []).some((mv) =>
                    String(mv).toLowerCase().includes(qlc)
                  );
                moveHit = directHit(p.fast_moves) || directHit(p.charged_moves);
                if (!moveHit) {
                  const allMv = [
                    ...new Set([
                      ...(p.fast_moves || []),
                      ...(p.charged_moves || []),
                      ...(EXCLUSIVE_BY_POKEMON[p.pokemon_id] || []),
                    ]),
                  ];
                  const tries = allMv.map(async (m) => {
                    const n = await getMoveNames(m);
                    return [n.zh, n.ja, n.en].some((x) =>
                      String(x).toLowerCase().includes(qlc)
                    );
                  });
                  try {
                    moveHit = await Promise.any(tries);
                  } catch {
                    moveHit = false;
                  }
                }
              }
              if (nameHit || moveHit) out.push(p);
            }
            list = out;
          }

          list = sortPokemon(list);
          filtered = list;

          if (!list.length) {
            empty.style.display = "block";
            return;
          }
          empty.style.display = "none";

          const chunk = async (arr, size, fn) => {
            for (let i = 0; i < arr.length; i += size) {
              await Promise.all(arr.slice(i, i + size).map(fn));
            }
          };

          await chunk(list, 10, async (p) => {
            const names = p.names;
            const img = POKE.art(p.pokemon_id);

            // åŸºç¤å€™é¸ï¼šåŸå§‹ moves
            const fastBase = (p.fast_moves || [])
              .map((n) => state.moveIndex[n])
              .filter(Boolean);
            const chargedBase = (p.charged_moves || [])
              .map((n) => state.moveIndex[n])
              .filter(Boolean);

            // ä¾ EPS/DPS æ’åºå–å‰ 5
            const topFast = fastBase
              .filter((m) => m.kind === "fast")
              .sort((a, b) => (computeEPS(b) ?? -1) - (computeEPS(a) ?? -1))
              .slice(0, 5);

            const topCharged = chargedBase
              .filter((m) => m.kind === "charged")
              .sort((a, b) => (computeDPS(b) ?? -1) - (computeDPS(a) ?? -1))
              .slice(0, 5);

            // â˜… åŠ å…¥é™å®šæ‹›å¼ï¼ˆå¼·åˆ¶é¡¯ç¤ºï¼Œé¿å…é‡è¤‡ï¼‰
            const exList = EXCLUSIVE_BY_POKEMON[p.pokemon_id] || [];
            for (const exName of exList) {
              const mi = state.moveIndex[exName];
              if (!mi) continue;
              if (mi.kind === "fast") {
                if (!topFast.find((x) => x.name === mi.name))
                  topFast.push({ ...mi, ex: true });
              } else {
                if (!topCharged.find((x) => x.name === mi.name))
                  topCharged.push({ ...mi, ex: true });
              }
            }

            // é å…ˆè¼‰å…¥å°æ‡‰æ‹›å¼çš„ä¸‰èªåç¨±ï¼ˆå« EXï¼‰
            const allMoves = [
              ...new Set([
                ...topFast.map((m) => m.name),
                ...topCharged.map((m) => m.name),
                ...(EXCLUSIVE_BY_POKEMON[p.pokemon_id] || []),
              ]),
            ];
            await Promise.all(allMoves.map(getMoveNames));

            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
          <div class="head">
            <div class="sprite"><img loading="lazy" src="${img}" alt="${escapeHTML(
              names.en
            )}" onerror="this.src=''; this.parentElement.textContent='No image'"/></div>
            <div class="names">
              <div class="name-line"><span class="name-tag">ä¸­æ–‡</span><span class="name-text">${escapeHTML(
                names.zh || "â€”"
              )}</span><button class="name-tts-btn" data-tts="${escapeAttr(
              names.zh || names.en
            )}" data-lang="zh-TW" title="ä¸­æ–‡ç™¼éŸ³">ğŸ”Š</button></div>
              <div class="name-line"><span class="name-tag">EN</span><span class="name-text">${escapeHTML(
                names.en || "â€”"
              )}</span><button class="name-tts-btn" data-tts="${escapeAttr(
              names.en
            )}" data-lang="en-US" title="English">ğŸ”Š</button></div>
              <div class="name-line"><span class="name-tag">æ—¥æ–‡</span><span class="name-text">${escapeHTML(
                names.ja || "â€”"
              )}</span><button class="name-tts-btn" data-tts="${escapeAttr(
              names.ja || names.en
            )}" data-lang="ja-JP" title="æ—¥æœ¬èª">ğŸ”Š</button></div>
              <div class="region">
                <span class="badge">#${p.pokemon_id}</span>
                <span class="badge">${dexRegion(p.pokemon_id)}</span>
              </div>
            </div>
          </div>
          <div class="body" style="padding:10px 12px">
            <div><strong>å°æ‹›ï¼ˆä¾ EPS æ’åå‰ 5ï¼‰</strong></div>
            <div class="chips">${topFast
              .map((m) => moveChip(m, "eps"))
              .join("")}</div>
            <div style="margin-top:8px"><strong>å¤§æ‹›ï¼ˆä¾ DPS æ’åå‰ 5ï¼‰</strong></div>
            <div class="chips">${topCharged
              .map((m) => moveChip(m, "dps"))
              .join("")}</div>
          </div>
          <details ${expandChk.checked ? "open" : ""}>
            <summary>å±•é–‹æ‹›å¼å°ç…§è¡¨ï¼ˆä¸‰èªï¼‰</summary>
            ${movesTable(p, topFast, topCharged)}
          </details>
        `;

            // åç¨± TTS
            card.querySelectorAll(".name-tts-btn[data-tts]").forEach((btn) => {
              btn.addEventListener("click", () =>
                speak(btn.dataset.tts, btn.dataset.lang, btn)
              );
            });

            // è¡¨æ ¼ä¸­çš„ move TTSï¼ˆäº‹ä»¶å§”æ´¾ï¼‰
            card.addEventListener("click", (e) => {
              const btn = e.target.closest(".move-tts-btn[data-tts]");
              if (!btn) return;
              speak(btn.dataset.tts, btn.dataset.lang, btn);
            });

            results.appendChild(card);
          });
        }

        function escapeHTML(s) {
          return String(s).replace(
            /[&<>"']/g,
            (c) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              }[c])
          );
        }
        function escapeAttr(s) {
          return String(s).replace(/&/g, "&amp;").replace(/"/g, "&quot;");
        }

        function moveChip(m, metric) {
          const eps = computeEPS(m);
          const dps = computeDPS(m);
          const stat =
            metric === "eps"
              ? eps != null
                ? `${eps.toFixed(2)} EPS`
                : "â€”"
              : dps != null
              ? `${dps.toFixed(2)} DPS`
              : "â€”";
          const ex = m.ex ? ` <span class="ex">[EX]</span>` : "";
          return `<span class="pill">${escapeHTML(
            m.name
          )} ${ex} <span class="stat">(${stat})</span></span>`;
        }

        function dexRegion(id) {
          for (const [k, [a, b]] of Object.entries(REGIONS)) {
            if (id >= a && id <= b)
              return k.charAt(0).toUpperCase() + k.slice(1);
          }
          return "â€”";
        }

        function movesTable(p, topFast, topCharged) {
          // å°‡å…©é‚Šæ¸…å–®èˆ‡ï¼ˆå¯èƒ½ï¼‰æœªå…¥å‰ 5 çš„åŸå§‹ moves + EX åˆä½µï¼Œå»é‡å¾Œé¡¯ç¤º
          const baseNames = new Set([
            ...(p.fast_moves || []),
            ...(p.charged_moves || []),
          ]);
          const exNames = new Set(EXCLUSIVE_BY_POKEMON[p.pokemon_id] || []);
          const shown = new Set([
            ...topFast.map((m) => m.name),
            ...topCharged.map((m) => m.name),
          ]);
          const extra = [...baseNames, ...exNames].filter((n) => !shown.has(n));
          const all = [
            ...topFast.map((m) => ({ name: m.name, kind: "fast", ex: !!m.ex })),
            ...topCharged.map((m) => ({
              name: m.name,
              kind: "charged",
              ex: !!m.ex,
            })),
            ...extra.map((n) => {
              const mi = state.moveIndex[n] || { name: n, kind: "charged" };
              return {
                name: n,
                kind: mi.kind || "charged",
                ex: !!(mi && mi.ex),
              };
            }),
          ];

          const rows = [];
          for (const mv of all) {
            const mstat = state.moveIndex[mv.name] || {
              name: mv.name,
              kind: mv.kind,
            };
            const names = state.cacheMoveNames[mv.name] || {
              en: mv.name,
              ja: mv.name,
              zh: mv.name,
            };
            const eps = mstat.kind === "fast" ? computeEPS(mstat) : null;
            const dps = mstat.kind === "charged" ? computeDPS(mstat) : null;
            const exMark =
              mv.ex || mstat.ex ? `<span class="ex">[EX]</span>` : "";
            const zhBtn = `<button class="move-tts-btn" title="ä¸­æ–‡ç™¼éŸ³" data-tts="${escapeAttr(
              names.zh
            )}" data-lang="zh-TW">ğŸ”Š</button>`;
            const enBtn = `<button class="move-tts-btn" title="English" data-tts="${escapeAttr(
              names.en
            )}" data-lang="en-US">ğŸ”Š</button>`;
            const jaBtn = `<button class="move-tts-btn" title="æ—¥æœ¬èª" data-tts="${escapeAttr(
              names.ja
            )}" data-lang="ja-JP">ğŸ”Š</button>`;
            rows.push(`<tr>
          <td>${
            mv.kind === "fast" ? "å°æ‹› Fast" : "å¤§æ‹› Charged"
          } ${exMark}</td>
          <td>${escapeHTML(names.zh || "â€”")} ${zhBtn}</td>
          <td>${escapeHTML(names.en || "â€”")} ${enBtn}</td>
          <td>${escapeHTML(names.ja || "â€”")} ${jaBtn}</td>
          <td class="stat">${eps != null ? eps.toFixed(2) : ""}</td>
          <td class="stat">${dps != null ? dps.toFixed(2) : ""}</td>
        </tr>`);
          }
          return `<div style="overflow:auto"><table><thead><tr><th>ç¨®é¡</th><th>ä¸­æ–‡</th><th>English</th><th>æ—¥æœ¬èª</th><th>EPS</th><th>DPS</th></tr></thead><tbody>${rows.join(
            ""
          )}</tbody></table></div>`;
        }

        // Event listeners
        qInput.addEventListener("input", debounce(render, 250));
        regionSel.addEventListener("change", render);
        sortSel.addEventListener("change", render);
        expandChk.addEventListener("change", () => {
          render();
        });

        function debounce(fn, ms) {
          let t;
          return (...a) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...a), ms);
          };
        }

        // -------- Simple self-tests --------
        function runSelfTests() {
          const logs = [];
          const ok = (m) => logs.push(`âœ… ${m}`);
          const ng = (m) => logs.push(`âŒ ${m}`);

          try {
            const cards = $$(".card");
            if (cards.length > 0) ok(`Rendered ${cards.length} card(s)`);
            else ng("No cards rendered");
            const anyNameTTS = $$(".card .name-tts-btn[data-tts]").length > 0;
            anyNameTTS
              ? ok("Name TTS buttons found")
              : ng("No Name TTS buttons");
            const anyMoveTTS = $$(".card details [data-tts]").length > 0;
            anyMoveTTS
              ? ok("Move TTS buttons present")
              : ng("No Move TTS buttons");
            // æª¢æŸ¥æ˜¯å¦æœ‰ EX æ¨™è¨˜
            const anyEX = $$(".ex").length > 0;
            anyEX
              ? ok("Exclusive move labels [EX] present")
              : ok("No EX labels yet");
          } catch (e) {
            ng("Self-test crashed: " + e.message);
          }
          diag.textContent = logs.join("\n");
        }

        await loadAll();
      })();
    </script>
  </body>
</html>
